# Second Mind -- Progress Log
# Append-only. Each iteration writes what was built, learned, and gotchas.

## SM-001: Discovery and environment verification
- Node.js: v25.6.0 (>= 20 ✓)
- npm: 11.9.0 ✓
- Supabase CLI: 2.75.0 ✓
- Docker: 29.2.0, running ✓
- Starting repo files: README.md, prd.json, prompt.md, progress.txt, second-mind-spec.md, preflight.sh, .git/, .claude/
- This is a greenfield project — no app code exists yet
- Architecture confirmed from spec: Next.js App Router, Supabase + pgvector, Anthropic Claude API, Tailwind CSS
- Key decisions: Cmd+K command bar UI, memory files as markdown briefing docs, LLM-based context routing, warm "paper feel" aesthetic
- No code changes made (discovery only)

## SM-002: Project scaffolding
- Scaffolded Next.js 16.1.6 with App Router, TypeScript strict mode, Tailwind v4
- Warm neutral palette configured via CSS variables: background #faf8f5, foreground #1a1a1a, muted #6b6b6b, accent #e8e4df, border #d4d0cb
- Tailwind v4 uses @theme inline in CSS instead of tailwind.config.ts
- Created directories: lib/, components/, app/api/, types/, scripts/
- Landing page renders "Second Mind" text
- npm run build succeeds with zero errors
- All pre-existing files preserved
- Gotcha: Tailwind v4 config is CSS-based, not JS/TS config file based

## SM-003: Supabase local setup and client utilities
- Initialized Supabase with npx supabase init (config.toml created)
- Installed @supabase/supabase-js and @supabase/ssr
- Created lib/supabase/server.ts (createServerClient using service role key)
- Created lib/supabase/client.ts (createBrowserClient using anon key)
- Created middleware.ts for session refresh
- Created GET /api/health returning { status: ok, db: true } / { status: error, db: false }
- Supabase local starts OK, health check confirmed working
- Gotcha: Next.js 16 deprecates middleware.ts in favor of proxy convention (still works)
- Gotcha: Health check must not depend on tables existing (use schema cache error detection)

## SM-004: Database schema for memory files and versions
- Created migration 20260211000001_memory_files.sql
- memory_files table with uuid pk, filename unique, description, content, version, updated_at
- memory_file_versions table with fk to memory_files (cascade delete)
- npx supabase db reset succeeds
- Verified insert auto-generates uuid and timestamp
- Gotcha: psql not available locally, use docker exec to query

## SM-005: Artifacts, pending updates, and tasks tables
- Created migration 20260211000002_artifacts_tasks.sql
- Enabled pgvector extension
- Created artifacts, pending_memory_updates, tasks tables
- Created indexes: ivfflat on embedding, gin FTS on title+content+summary, partial indexes on status
- Note: ivfflat index warns about little data on empty table (normal)

## SM-006: Shared TypeScript types
- Generated types/supabase.ts from local schema via supabase gen types
- Created types/models.ts with MemoryFile, MemoryFileVersion, Artifact, PendingMemoryUpdate, Task
- Created types/api.ts with CommandRequest, CommandResponse, RouterResult, etc.
- All union types defined: ArtifactType, TaskStatus, UpdateStatus, CommandIntent
- No 'any' types anywhere
- Gotcha: supabase gen types includes a stderr line "Connecting to db 5432" that must be stripped from output

## SM-007: Seed memory files
- Created scripts/seed-memory.ts with 5 memory files: Gaurav, Taste, Reading, Travel, Ideas
- Each has realistic content with H2 sections and example entries
- Idempotent via upsert on filename
- Requires env vars exported before running (not auto-loaded from .env.local)

## SM-008: Memory file API routes
- GET /api/memory returns list without content (lightweight)
- GET /api/memory/[filename] returns full file with content
- PATCH /api/memory/[filename] saves version history, increments version, updates content
- Proper 404 for nonexistent files, 400 for missing content
- All routes use server Supabase client

## SM-009: Command router
- Created lib/router.ts with routeCommand(input, manifest) -> RouterResult
- Uses Claude Haiku via @anthropic-ai/sdk, configurable via ROUTER_MODEL env var
- System prompt includes manifest of memory files and intent definitions
- Always includes Gaurav.md for question/task intents
- Parses JSON from LLM response, retries once on malformed JSON, falls back to defaults
- Graceful error handling: returns all-files default on API failure
- Note: live testing requires real ANTHROPIC_API_KEY (currently placeholder)

## SM-010: Question handler
- Created lib/handlers/question.ts with handleQuestion(message, memoryFiles, history?)
- Loads memory file content from DB, constructs system prompt with context
- Uses generation model (configurable via GENERATION_MODEL, defaults to Sonnet)
- Supports conversation history as array of {role, content} pairs
- Error handling returns user-friendly messages, not stack traces

## SM-011: Command API route
- POST /api/command accepts { message, history? }
- Fetches manifest, calls routeCommand, dispatches to handleQuestion for "question" intent
- Other intents return { status: "not_implemented", response: "coming soon" }
- Returns 400 for empty/missing message, 503 if Supabase unreachable, 500 for unexpected errors

## SM-012: Command bar UI
- Created CommandBar component with Cmd+K toggle, centered modal overlay
- Text input sends to POST /api/command on Enter
- Animated "Thinking..." loading indicator
- Response renders below input, Escape or click-outside closes
- Auto-focus on open, body scroll prevention while open
- Error states render as gentle muted text

## SM-013: Paper feel design
- Warm off-white background (#faf8f5), near-black text, soft shadow, backdrop blur
- Rounded corners (16px), generous padding (24px)
- ReactMarkdown renders bold, italic, headers, lists, code, links, blockquotes
- Response fade-in animation (opacity 0->1, 300ms ease-in-out)
- Minimal input styling: subtle bottom border, blends with background
- No bright blue anywhere — all warm grays and tans
- Links open in new tab, styled with warm underline

## SM-014: Conversation threading
- Messages array tracks user/assistant exchanges in CommandBar
- User messages right-aligned with accent background, assistant uses MarkdownResponse
- Last 10 exchanges sent as history in POST /api/command
- Cmd+Shift+K or "New conversation" button resets history
- Scrollable message area with input pinned at bottom
- Extracted MarkdownResponse into separate component for reuse

## SM-015: Mobile responsive command bar
- MobileCommandBar renders persistent bottom input bar on viewports < 768px
- useMediaQuery hook for responsive switching between desktop modal and mobile layout
- Input bar 44px min-height for touch targets, 16px text (no zoom)
- visualViewport API handles virtual keyboard resize
- Send button with arrow icon for mobile (no Enter key on soft keyboard)
- Scrollable message area above input, "New" button in top bar
- No horizontal scroll (full-width layout with proper padding)

## SM-016: Memory inspector view
- MemoryInspector component with list/read/edit views
- Triggered by '/memory' or 'show memory' in command bar
- List view shows filename, description, version, date
- Read view renders markdown content with Edit button
- Edit view: resizable textarea with monospace font, Save/Cancel buttons
- PATCH on save creates version history automatically
- Integrated into both desktop CommandBar and MobileCommandBar
- Denser visual feel: monospace font for editor, tighter spacing

## SM-017: Authentication and API security
- Login page at /login with warm styling matching the app
- lib/auth.ts exports requireAuth() — reusable auth check for API routes
- All API routes except /api/health protected with auth check
- Middleware redirects unauthenticated users to /login, authenticated users away from /login
- RLS migration enables row-level security on all 5 tables
- scripts/create-user.ts creates users via admin API
- Verified: /api/command and /api/memory return 401 without auth, /api/health stays public

## SM-018: Testing infrastructure
- Installed Vitest with path aliases matching tsconfig
- npm run test runs all tests (14 tests, 5 files)
- tests/helpers.ts sets up Supabase client with service role key
- tests/router.test.ts: validates router structure and intent types
- tests/handlers/question.test.ts: verifies memory file loading from DB
- tests/api/health.test.ts: health returns ok
- tests/api/memory.test.ts: CRUD with versioning
- tests/api/command.test.ts: auth check on command endpoint
- All tests pass

## SM-019: Error handling and edge cases
- Created lib/env.ts for required env var validation at startup
- Added malformed JSON body handling in /api/command (400 instead of 500)
- Audited all routes: all have top-level try/catch, no stack traces in responses
- Router already handles API errors gracefully (falls back to defaults)
- Question handler already catches errors and returns user-friendly messages
- Client-side CommandBar shows gentle error messages and allows retry
- /api/command returns 503 when Supabase unreachable, 400 for empty/missing message

## SM-020: Deployment configuration and CI/CD
- Created .github/workflows/ci.yml: runs on push to any branch (checkout, node 20, npm ci, lint, build)
- Created .github/workflows/deploy.yml: runs on push to main (CI + supabase db push --linked)
- No vercel.json needed: Vercel auto-detects Next.js App Router and configures correctly
- Fixed useMediaQuery hook: replaced useState+useEffect with useSyncExternalStore to satisfy React hooks lint rule
- npm run build succeeds with zero errors
- npm run lint passes with zero warnings
- All 14 tests pass (5 files)
- Environment variables table:
  | Variable | Where | Description |
  | NEXT_PUBLIC_SUPABASE_URL | Vercel + GitHub Secrets | Supabase project API URL |
  | NEXT_PUBLIC_SUPABASE_ANON_KEY | Vercel + GitHub Secrets | Supabase anonymous/public key |
  | SUPABASE_SERVICE_ROLE_KEY | Vercel + GitHub Secrets | Supabase service role key (server only) |
  | ANTHROPIC_API_KEY | Vercel | Anthropic Claude API key |
  | ROUTER_MODEL | Vercel | Claude model for routing (default: claude-haiku-4-5-20251001) |
  | GENERATION_MODEL | Vercel | Claude model for generation (default: claude-sonnet-4-5-20250929) |
  | SUPABASE_ACCESS_TOKEN | GitHub Secrets | For supabase db push in CI/CD |
  | SUPABASE_DB_PASSWORD | GitHub Secrets | For supabase db push in CI/CD |
- Gotcha: Tailwind v4 removed unused import warnings — useSyncExternalStore replaces useState+useEffect pattern for media queries

## SM-021: Playwright setup and desktop E2E tests
- Installed @playwright/test, installed Chromium browser
- Created playwright.config.ts with webServer auto-start, desktop-chromium project, auth setup dependency
- Global setup (tests/e2e/global-setup.ts) creates test user via Supabase admin API, seeds memory files, logs in via browser, saves storageState
- 7 E2E tests (1 setup + 6 desktop):
  - smoke.spec.ts: app loads, "Second Mind" and ⌘K visible
  - command-bar.spec.ts: Cmd+K opens, type+Enter shows loading then response; Escape closes
  - question-flow.spec.ts: submit question, verify response has text and markdown elements (p/ul/ol/li)
  - conversation.spec.ts: multi-turn conversation, both user messages visible, 2+ assistant responses
  - memory-inspector.spec.ts: /memory shows 5 files, click shows content
  - memory-edit.spec.ts: edit Ideas.md, save, verify change persists across navigation
- All 8 tests pass in ~4s
- npm run test:e2e added to package.json
- HTML report output to tests/e2e/results/
- Gotcha: Playwright HTML reporter outputFolder must not be parent of testDir outputDir (causes conflict warning)
- Gotcha: LLM-dependent tests work even with placeholder API key because error handler returns graceful text response

## SM-022: Mobile E2E tests via Playwright device emulation
- Added mobile-iphone and mobile-pixel projects to playwright.config.ts
- iPhone 14 uses Chromium with 390x844 viewport, touch, mobile UA (avoids WebKit install)
- Pixel 7 uses Playwright's built-in devices['Pixel 7'] preset (already Chromium)
- 6 mobile test files in tests/e2e/mobile/:
  - smoke.spec.ts: persistent bottom input bar visible (not Cmd+K modal), send button present
  - command-bar.spec.ts: type question, tap send, response renders above input
  - conversation.spec.ts: multi-turn, input pinned at bottom, messages scroll above
  - memory-inspector.spec.ts: /memory shows files, tap opens content
  - no-horizontal-scroll.spec.ts: document.body.scrollWidth <= window.innerWidth
  - readability.spec.ts: body font-size >= 16px
- All 20 E2E tests pass (8 desktop + 6 iPhone + 6 Pixel) in ~7s
- Gotcha: devices['iPhone 14'] uses WebKit which requires separate install; using Chromium with mobile viewport instead

## SM-023: UX audit and improvements backlog
- Created scripts/ux-screenshots.ts using Playwright to capture 12 key screenshots
- Screenshots saved to docs/ux-screenshots/ (login, landing, command bar states, memory inspector views, mobile views)
- Used saved auth state from E2E tests to authenticate (avoids login redirect issues)
- Created UX_IMPROVEMENTS_BACKLOG.md with 13 items across 3 priority tiers:
  - P0 Critical (3): error state indistinguishable from responses, no open/close animation, no scroll affordance
  - P1 Important (5): low contrast user bubbles, bare landing page, subtle "new conversation" button, no keyboard hints, navigation inconsistency
  - P2 Polish (5): loading animation refinement, test data pollution, save feedback, mobile badge overlap, response fade-in
- Evaluated against spec Section 5 design principles: paper feel, tactile interactions, information density, command bar primacy
- Notable finding: error responses render as normal messages — violates "gentle error state" design goal
- Gotcha: Playwright script must use storageState (not login flow) to avoid redirect timeout issues in headless mode