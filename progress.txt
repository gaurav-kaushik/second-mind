# Second Mind -- Progress Log
# Append-only. Each iteration writes what was built, learned, and gotchas.

## SM-001: Discovery and environment verification
- Node.js: v25.6.0 (>= 20 ✓)
- npm: 11.9.0 ✓
- Supabase CLI: 2.75.0 ✓
- Docker: 29.2.0, running ✓
- Starting repo files: README.md, prd.json, prompt.md, progress.txt, second-mind-spec.md, preflight.sh, .git/, .claude/
- This is a greenfield project — no app code exists yet
- Architecture confirmed from spec: Next.js App Router, Supabase + pgvector, Anthropic Claude API, Tailwind CSS
- Key decisions: Cmd+K command bar UI, memory files as markdown briefing docs, LLM-based context routing, warm "paper feel" aesthetic
- No code changes made (discovery only)

## SM-002: Project scaffolding
- Scaffolded Next.js 16.1.6 with App Router, TypeScript strict mode, Tailwind v4
- Warm neutral palette configured via CSS variables: background #faf8f5, foreground #1a1a1a, muted #6b6b6b, accent #e8e4df, border #d4d0cb
- Tailwind v4 uses @theme inline in CSS instead of tailwind.config.ts
- Created directories: lib/, components/, app/api/, types/, scripts/
- Landing page renders "Second Mind" text
- npm run build succeeds with zero errors
- All pre-existing files preserved
- Gotcha: Tailwind v4 config is CSS-based, not JS/TS config file based

## SM-003: Supabase local setup and client utilities
- Initialized Supabase with npx supabase init (config.toml created)
- Installed @supabase/supabase-js and @supabase/ssr
- Created lib/supabase/server.ts (createServerClient using service role key)
- Created lib/supabase/client.ts (createBrowserClient using anon key)
- Created middleware.ts for session refresh
- Created GET /api/health returning { status: ok, db: true } / { status: error, db: false }
- Supabase local starts OK, health check confirmed working
- Gotcha: Next.js 16 deprecates middleware.ts in favor of proxy convention (still works)
- Gotcha: Health check must not depend on tables existing (use schema cache error detection)

## SM-004: Database schema for memory files and versions
- Created migration 20260211000001_memory_files.sql
- memory_files table with uuid pk, filename unique, description, content, version, updated_at
- memory_file_versions table with fk to memory_files (cascade delete)
- npx supabase db reset succeeds
- Verified insert auto-generates uuid and timestamp
- Gotcha: psql not available locally, use docker exec to query

## SM-005: Artifacts, pending updates, and tasks tables
- Created migration 20260211000002_artifacts_tasks.sql
- Enabled pgvector extension
- Created artifacts, pending_memory_updates, tasks tables
- Created indexes: ivfflat on embedding, gin FTS on title+content+summary, partial indexes on status
- Note: ivfflat index warns about little data on empty table (normal)

## SM-006: Shared TypeScript types
- Generated types/supabase.ts from local schema via supabase gen types
- Created types/models.ts with MemoryFile, MemoryFileVersion, Artifact, PendingMemoryUpdate, Task
- Created types/api.ts with CommandRequest, CommandResponse, RouterResult, etc.
- All union types defined: ArtifactType, TaskStatus, UpdateStatus, CommandIntent
- No 'any' types anywhere
- Gotcha: supabase gen types includes a stderr line "Connecting to db 5432" that must be stripped from output

## SM-007: Seed memory files
- Created scripts/seed-memory.ts with 5 memory files: Gaurav, Taste, Reading, Travel, Ideas
- Each has realistic content with H2 sections and example entries
- Idempotent via upsert on filename
- Requires env vars exported before running (not auto-loaded from .env.local)

## SM-008: Memory file API routes
- GET /api/memory returns list without content (lightweight)
- GET /api/memory/[filename] returns full file with content
- PATCH /api/memory/[filename] saves version history, increments version, updates content
- Proper 404 for nonexistent files, 400 for missing content
- All routes use server Supabase client

## SM-009: Command router
- Created lib/router.ts with routeCommand(input, manifest) -> RouterResult
- Uses Claude Haiku via @anthropic-ai/sdk, configurable via ROUTER_MODEL env var
- System prompt includes manifest of memory files and intent definitions
- Always includes Gaurav.md for question/task intents
- Parses JSON from LLM response, retries once on malformed JSON, falls back to defaults
- Graceful error handling: returns all-files default on API failure
- Note: live testing requires real ANTHROPIC_API_KEY (currently placeholder)

## SM-010: Question handler
- Created lib/handlers/question.ts with handleQuestion(message, memoryFiles, history?)
- Loads memory file content from DB, constructs system prompt with context
- Uses generation model (configurable via GENERATION_MODEL, defaults to Sonnet)
- Supports conversation history as array of {role, content} pairs
- Error handling returns user-friendly messages, not stack traces

## SM-011: Command API route
- POST /api/command accepts { message, history? }
- Fetches manifest, calls routeCommand, dispatches to handleQuestion for "question" intent
- Other intents return { status: "not_implemented", response: "coming soon" }
- Returns 400 for empty/missing message, 503 if Supabase unreachable, 500 for unexpected errors

## SM-012: Command bar UI
- Created CommandBar component with Cmd+K toggle, centered modal overlay
- Text input sends to POST /api/command on Enter
- Animated "Thinking..." loading indicator
- Response renders below input, Escape or click-outside closes
- Auto-focus on open, body scroll prevention while open
- Error states render as gentle muted text

## SM-013: Paper feel design
- Warm off-white background (#faf8f5), near-black text, soft shadow, backdrop blur
- Rounded corners (16px), generous padding (24px)
- ReactMarkdown renders bold, italic, headers, lists, code, links, blockquotes
- Response fade-in animation (opacity 0->1, 300ms ease-in-out)
- Minimal input styling: subtle bottom border, blends with background
- No bright blue anywhere — all warm grays and tans
- Links open in new tab, styled with warm underline

## SM-014: Conversation threading
- Messages array tracks user/assistant exchanges in CommandBar
- User messages right-aligned with accent background, assistant uses MarkdownResponse
- Last 10 exchanges sent as history in POST /api/command
- Cmd+Shift+K or "New conversation" button resets history
- Scrollable message area with input pinned at bottom
- Extracted MarkdownResponse into separate component for reuse

## SM-015: Mobile responsive command bar
- MobileCommandBar renders persistent bottom input bar on viewports < 768px
- useMediaQuery hook for responsive switching between desktop modal and mobile layout
- Input bar 44px min-height for touch targets, 16px text (no zoom)
- visualViewport API handles virtual keyboard resize
- Send button with arrow icon for mobile (no Enter key on soft keyboard)
- Scrollable message area above input, "New" button in top bar
- No horizontal scroll (full-width layout with proper padding)